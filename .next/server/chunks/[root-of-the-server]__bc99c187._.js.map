{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/techs/Downloads/nextjs_1%20%282%29/nextjs_1/src/lib/siteAClient.js"],"sourcesContent":["export const sendTransactionToSiteB = async (transactionPayload) => {\r\n  try {\r\n    const SITE_A_PROXY_ENDPOINT = \"/api/transactions\";\r\n    const BEARER_TOKEN = process.env.NEXT_PUBLIC_BEARER_TOKEN || \"testtoken123\";\r\n    const SHARED_SECRET = process.env.SHARED_SECRET || \"mytransactionsecratekeyinder81\";\r\n\r\n    // Ensure complete payload\r\n    const completePayload = {\r\n      txnId: transactionPayload.txnId || `TXN-${Date.now()}`,\r\n      payerName: transactionPayload.payerName || \"Unknown User\",\r\n      payerEmail: transactionPayload.payerEmail || \"unknown@example.com\",\r\n      amount: transactionPayload.amount || 0,\r\n      description: transactionPayload.description || \"Payment\",\r\n      type: transactionPayload.type || \"PAYMENT\",\r\n      referenceId: transactionPayload.referenceId || \"REF-${Date.now()}\",\r\n      currency: transactionPayload.currency || \"INR\",\r\n      status: transactionPayload.status || \"UNKNOWN\",\r\n      responseMessage: transactionPayload.responseMessage || \"\",\r\n      userId: transactionPayload.userId || \"\",\r\n      metadata: transactionPayload.metadata || {},\r\n      statusCode: transactionPayload.statusCode || \"PENDING\",\r\n      createdAt: transactionPayload.createdAt || new Date().toISOString(),\r\n    };\r\n\r\n    console.log(\"Sending to Site B:\", SITE_A_PROXY_ENDPOINT, completePayload);\r\n\r\n    const response = await fetch(SITE_A_PROXY_ENDPOINT, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Authorization\": `Bearer ${BEARER_TOKEN}`,\r\n        \"x-shared-secret\": SHARED_SECRET,\r\n      },\r\n      body: JSON.stringify(completePayload),\r\n    });\r\n\r\n    const responseText = await response.text();\r\n    console.log(\"Raw Response:\", responseText);\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Site B Error (Status ${response.status}): ${responseText}`);\r\n    }\r\n\r\n    let data;\r\n    try {\r\n      data = JSON.parse(responseText);\r\n    } catch {\r\n      data = { raw: responseText };\r\n    }\r\n\r\n    console.log(\"Parsed Response:\", data);\r\n    return data;\r\n  } catch (error) {\r\n    console.error(\"Failed to send transaction:\", error.message);\r\n    throw error;\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;AAAO,MAAM,yBAAyB,OAAO;IAC3C,IAAI;QACF,MAAM,wBAAwB;QAC9B,MAAM,eAAe,uDAAwC;QAC7D,MAAM,gBAAgB,QAAQ,GAAG,CAAC,aAAa,IAAI;QAEnD,0BAA0B;QAC1B,MAAM,kBAAkB;YACtB,OAAO,mBAAmB,KAAK,IAAI,CAAC,IAAI,EAAE,KAAK,GAAG,IAAI;YACtD,WAAW,mBAAmB,SAAS,IAAI;YAC3C,YAAY,mBAAmB,UAAU,IAAI;YAC7C,QAAQ,mBAAmB,MAAM,IAAI;YACrC,aAAa,mBAAmB,WAAW,IAAI;YAC/C,MAAM,mBAAmB,IAAI,IAAI;YACjC,aAAa,mBAAmB,WAAW,IAAI;YAC/C,UAAU,mBAAmB,QAAQ,IAAI;YACzC,QAAQ,mBAAmB,MAAM,IAAI;YACrC,iBAAiB,mBAAmB,eAAe,IAAI;YACvD,QAAQ,mBAAmB,MAAM,IAAI;YACrC,UAAU,mBAAmB,QAAQ,IAAI,CAAC;YAC1C,YAAY,mBAAmB,UAAU,IAAI;YAC7C,WAAW,mBAAmB,SAAS,IAAI,IAAI,OAAO,WAAW;QACnE;QAEA,QAAQ,GAAG,CAAC,sBAAsB,uBAAuB;QAEzD,MAAM,WAAW,MAAM,MAAM,uBAAuB;YAClD,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,iBAAiB,CAAC,OAAO,EAAE,cAAc;gBACzC,mBAAmB;YACrB;YACA,MAAM,KAAK,SAAS,CAAC;QACvB;QAEA,MAAM,eAAe,MAAM,SAAS,IAAI;QACxC,QAAQ,GAAG,CAAC,iBAAiB;QAE7B,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,qBAAqB,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,cAAc;QAC7E;QAEA,IAAI;QACJ,IAAI;YACF,OAAO,KAAK,KAAK,CAAC;QACpB,EAAE,OAAM;YACN,OAAO;gBAAE,KAAK;YAAa;QAC7B;QAEA,QAAQ,GAAG,CAAC,oBAAoB;QAChC,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B,MAAM,OAAO;QAC1D,MAAM;IACR;AACF","debugId":null}},
    {"offset": {"line": 133, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/techs/Downloads/nextjs_1%20%282%29/nextjs_1/src/app/api/payment/callback/route.js"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport crypto from 'crypto'\r\nimport { sendTransactionToSiteB } from '@/lib/siteAClient'\r\n\r\n/**\r\n * ============================================\r\n * PAYMENT CALLBACK API - DESIGNED & ORGANIZED\r\n * ============================================\r\n * This route handles payment callbacks from SabPaisa gateway\r\n * It decrypts the response, processes the payment status,\r\n * and updates Site B with transaction details\r\n */\r\n\r\n// ============================================\r\n// CONSTANTS & CONFIGURATION\r\n// ============================================\r\nconst DEFAULT_AUTH_KEY = 'doJx8Ihyb2s/sh1pbYEDfa6JdsogEYMXKEoPF/BEwrg='\r\nconst DEFAULT_AUTH_IV = 'iw/0vT01OWRph/rQplst/W7k423JXrgo4xBn3gXPsIDXTTXE461f4V4QYKGQ8wTe'\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS - DECRYPTION\r\n// ============================================\r\n\r\n/**\r\n * Decrypts SabPaisa encrypted response using AES-256-CBC\r\n * Tries multiple decryption approaches for compatibility\r\n */\r\nfunction decryptSabPaisaResponse(encResponse, authKey, authIV) {\r\n  try {\r\n    // Decode base64 strings for key and IV\r\n    const key = Buffer.from(authKey || DEFAULT_AUTH_KEY, 'base64')\r\n    const fullIV = Buffer.from(authIV || DEFAULT_AUTH_IV, 'base64')\r\n    \r\n    // IV must be exactly 16 bytes for AES-256-CBC\r\n    const iv = fullIV.slice(0, 16)\r\n    \r\n    // Log input details for debugging\r\n    console.log('Input details:', {\r\n      encResponseLength: encResponse ? encResponse.length : 0,\r\n      keyLength: key.length,\r\n      ivLength: iv.length,\r\n      isHex: /^[0-9A-Fa-f]+$/.test(encResponse || ''),\r\n    })\r\n    \r\n    // If no encrypted response, return a mock response for testing\r\n    if (!encResponse) {\r\n      console.log('No encrypted response provided, returning mock data')\r\n      return {\r\n        status: 'success',\r\n        message: 'This is a mock response for testing',\r\n        txnId: 'MOCK_TXN_' + Date.now(),\r\n        amount: '100.00',\r\n        paymentMode: 'TEST',\r\n        paymentDateTime: new Date().toISOString()\r\n      }\r\n    }\r\n    \r\n    // SabPaisa specific handling - try multiple approaches\r\n    \r\n    // APPROACH 1: Try with custom padding for SabPaisa format\r\n    try {\r\n      // Convert hex to buffer\r\n      const encryptedData = Buffer.from(encResponse, 'hex')\r\n      \r\n      // Calculate padding needed for AES block size (16 bytes)\r\n      const blockSize = 16\r\n      const remainder = encryptedData.length % blockSize\r\n      const paddingNeeded = remainder === 0 ? 0 : blockSize - remainder\r\n      \r\n      // Add padding if needed\r\n      let paddedData = encryptedData\r\n      if (paddingNeeded > 0) {\r\n        paddedData = Buffer.concat([encryptedData, Buffer.alloc(paddingNeeded, paddingNeeded)])\r\n        console.log('Added PKCS#7 padding:', paddingNeeded, 'bytes')\r\n      }\r\n      \r\n      // Create decipher with manual padding handling\r\n      const decipher = crypto.createDecipheriv('aes-256-cbc', key, iv)\r\n      decipher.setAutoPadding(false)\r\n      \r\n      // Decrypt the data\r\n      let decrypted = decipher.update(paddedData)\r\n      decrypted = Buffer.concat([decrypted, decipher.final()])\r\n      \r\n      // Remove PKCS#7 padding manually\r\n      const lastByte = decrypted[decrypted.length - 1]\r\n      if (lastByte <= blockSize) {\r\n        let validPadding = true\r\n        for (let i = 1; i <= lastByte; i++) {\r\n          if (decrypted[decrypted.length - i] !== lastByte) {\r\n            validPadding = false\r\n            break\r\n          }\r\n        }\r\n        \r\n        if (validPadding) {\r\n          decrypted = decrypted.slice(0, decrypted.length - lastByte)\r\n        }\r\n      }\r\n      \r\n      // Convert to string and clean up non-printable characters\r\n      let result = decrypted.toString('utf8')\r\n      console.log('Raw decrypted result (first 100 chars):', result.substring(0, 100))\r\n      \r\n      // Clean the result by removing non-printable characters\r\n      const cleanedResult = result.replace(/[\\x00-\\x1F\\x7F-\\x9F]/g, '')\r\n      \r\n      // Try to find a valid JSON object in the result\r\n      const jsonMatch = cleanedResult.match(/\\{[^\\{\\}]*(?:\\{[^\\{\\}]*\\}[^\\{\\}]*)*\\}/)\r\n      if (jsonMatch) {\r\n        console.log('Found JSON object in decrypted data')\r\n        try {\r\n          const parsedJson = JSON.parse(jsonMatch[0])\r\n          console.log('Successfully parsed JSON from decrypted data')\r\n          return parsedJson\r\n        } catch (jsonError) {\r\n          console.log('Found JSON-like content but failed to parse:', jsonError.message)\r\n        }\r\n      }\r\n      \r\n      // If we couldn't find valid JSON, try to extract key-value pairs\r\n      const keyValuePairs = cleanedResult.match(/([\\w]+)=([^&]+)&?/g)\r\n      if (keyValuePairs && keyValuePairs.length > 0) {\r\n        console.log('Found key-value pairs in decrypted data')\r\n        const resultObj = {}\r\n        keyValuePairs.forEach(pair => {\r\n          const [key, value] = pair.replace('&', '').split('=')\r\n          if (key && value) {\r\n            resultObj[key] = value\r\n          }\r\n        })\r\n        \r\n        if (Object.keys(resultObj).length > 0) {\r\n          console.log('Created object from key-value pairs')\r\n          return resultObj\r\n        }\r\n      }\r\n    } catch (approachError) {\r\n      console.log('Custom padding approach failed:', approachError.message)\r\n    }\r\n    \r\n    // APPROACH 2: Try direct hex decoding with auto padding\r\n    try {\r\n      const encryptedData = Buffer.from(encResponse, 'hex')\r\n      const decipher = crypto.createDecipheriv('aes-256-cbc', key, iv)\r\n      let decrypted = decipher.update(encryptedData)\r\n      decrypted = Buffer.concat([decrypted, decipher.final()])\r\n      \r\n      const result = decrypted.toString('utf8')\r\n      console.log('Direct hex approach succeeded')\r\n      \r\n      try {\r\n        return JSON.parse(result)\r\n      } catch (jsonError) {\r\n        console.log('JSON parsing failed, returning raw result')\r\n        return { rawResponse: result }\r\n      }\r\n    } catch (directError) {\r\n      console.log('Direct hex approach failed:', directError.message)\r\n    }\r\n    \r\n    // APPROACH 3: Try base64 decoding\r\n    try {\r\n      const encryptedData = Buffer.from(encResponse, 'base64')\r\n      const decipher = crypto.createDecipheriv('aes-256-cbc', key, iv)\r\n      let decrypted = decipher.update(encryptedData)\r\n      decrypted = Buffer.concat([decrypted, decipher.final()])\r\n      \r\n      const result = decrypted.toString('utf8')\r\n      console.log('Base64 approach succeeded')\r\n      \r\n      try {\r\n        return JSON.parse(result)\r\n      } catch (jsonError) {\r\n        console.log('JSON parsing failed, returning raw result')\r\n        return { rawResponse: result }\r\n      }\r\n    } catch (base64Error) {\r\n      console.log('Base64 approach failed:', base64Error.message)\r\n    }\r\n    \r\n    // APPROACH 4: Return a fallback response with the error\r\n    console.log('All decryption approaches failed, returning fallback response')\r\n    return {\r\n      status: 'error',\r\n      message: 'Failed to decrypt the payment response',\r\n      encryptedResponse: encResponse.substring(0, 50) + '...',\r\n      clientCode: 'INDR81',\r\n      timestamp: new Date().toISOString()\r\n    }\r\n  } catch (error) {\r\n    console.error('Decryption error:', error)\r\n    // Instead of throwing, return an error object\r\n    return {\r\n      status: 'error',\r\n      message: `Failed to decrypt response: ${error.message}`,\r\n      timestamp: new Date().toISOString()\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS - VALIDATION\r\n// ============================================\r\n\r\n/**\r\n * Validates required callback parameters\r\n */\r\nfunction validateCallbackParams(clientCode, encResponse) {\r\n  const errors = []\r\n  \r\n  if (!clientCode) {\r\n    errors.push('clientCode is required')\r\n  }\r\n  \r\n  if (!encResponse) {\r\n    errors.push('encResponse is required')\r\n  }\r\n  \r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if request is from a browser\r\n */\r\nfunction isBrowserRequest(request) {\r\n  const acceptHeader = request.headers.get('accept') || ''\r\n  const userAgent = request.headers.get('user-agent') || ''\r\n  \r\n  return acceptHeader.includes('text/html') || userAgent.includes('Mozilla')\r\n}\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS - STATUS MAPPING\r\n// ============================================\r\n\r\n/**\r\n * Maps SabPaisa payment status to standardized status\r\n */\r\nfunction mapPaymentStatus(paymentData) {\r\n  const rawStatus = (paymentData.status || paymentData.STATUS || paymentData.paymentStatus || '').toString().toUpperCase()\r\n  const statusCode = (paymentData.statusCode || paymentData.STATUS_CODE || paymentData.gatewayResponseCode || '').toString()\r\n  const respMsg = (paymentData.sabpaisaMessage || paymentData.responseMessage || paymentData.RESPONSE_MESSAGE || paymentData.message || paymentData.bankMessage || '').toString()\r\n\r\n  // Known success signals\r\n  const isExplicitSuccess = rawStatus === 'SUCCESS' || rawStatus === 'SUCCESSFUL' || rawStatus === 'COMPLETED'\r\n  if (isExplicitSuccess) {\r\n    return { status: 'success', message: respMsg || 'Payment completed successfully!' }\r\n  }\r\n\r\n  // Known failure signals\r\n  const isExplicitFailure = rawStatus === 'FAILED' || rawStatus === 'FAILURE' || rawStatus === 'CANCELLED' || rawStatus === 'CANCELED' || rawStatus === 'ERROR' || rawStatus === 'REJECTED'\r\n  if (isExplicitFailure) {\r\n    return { status: 'cancelled', message: respMsg || 'Payment was cancelled or failed.' }\r\n  }\r\n\r\n  // Check status codes for additional validation\r\n  if (statusCode === '0000' || statusCode === '00') {\r\n    return { status: 'success', message: respMsg || 'Payment completed successfully!' }\r\n  }\r\n  \r\n  if (statusCode && statusCode !== '0000' && statusCode !== '00') {\r\n    return { status: 'cancelled', message: respMsg || 'Payment failed with status code: ' + statusCode }\r\n  }\r\n\r\n  // Otherwise keep pending\r\n  return { status: 'pending', message: respMsg || 'Payment is being processed...' }\r\n}\r\n\r\n/**\r\n * Extracts field value with multiple fallback options\r\n */\r\nfunction extractField(obj, fieldNames, defaultValue = '') {\r\n  for (const fieldName of fieldNames) {\r\n    if (obj[fieldName] !== undefined && obj[fieldName] !== null && obj[fieldName] !== '') {\r\n      return obj[fieldName]\r\n    }\r\n  }\r\n  return defaultValue\r\n}\r\n\r\n/**\r\n * Builds payload for Site B update\r\n */\r\nfunction buildSiteBPayload(decryptedData, statusInfo) {\r\n  return {\r\n    txnId: extractField(decryptedData, ['clientTxnId', 'CLIENT_TXN_ID', 'txnId'], ''),\r\n    sabpaisaTxnId: extractField(decryptedData, ['sabpaisaTxnId', 'SABPAISA_TXN_ID', 'txnId'], ''),\r\n    referenceId: extractField(decryptedData, ['clientTxnId', 'CLIENT_TXN_ID', 'txnId'], ''),\r\n    amount: Number(extractField(decryptedData, ['amount', 'AMOUNT'], 0)),\r\n    status: statusInfo.status === 'success' ? 'SUCCESS' : (statusInfo.status === 'cancelled' ? 'FAILED' : 'PENDING'),\r\n    responseMessage: extractField(decryptedData, ['sabpaisaMessage', 'responseMessage', 'message', 'bankMessage'], statusInfo.message),\r\n    userId: extractField(decryptedData, ['payerEmail', 'userId', 'PAYER_EMAIL'], ''),\r\n    type: extractField(decryptedData, ['type'], 'PAYMENT'),\r\n    description: extractField(decryptedData, ['description'], 'Payment'),\r\n    payerName: extractField(decryptedData, ['payerName', 'PAYER_NAME', 'customerName', 'CUSTOMER_NAME'], 'Unknown User'),\r\n    payerEmail: extractField(decryptedData, ['payerEmail', 'PAYER_EMAIL', 'email', 'EMAIL', 'userId'], ''),\r\n    statusCode: extractField(decryptedData, ['statusCode', 'STATUS_CODE', 'gatewayResponseCode', 'responseCode'], statusInfo.status === 'success' ? '0000' : '9999'),\r\n    metadata: { ...decryptedData },\r\n    createdAt: new Date().toISOString()\r\n  }\r\n}\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS - RESPONSE FORMATTING\r\n// ============================================\r\n\r\n/**\r\n * Creates error response with consistent format\r\n */\r\nfunction createErrorResponse(message, statusCode = 400, additionalData = {}) {\r\n  return NextResponse.json({\r\n    success: false,\r\n    status: 'error',\r\n    message,\r\n    timestamp: new Date().toISOString(),\r\n    ...additionalData\r\n  }, { status: statusCode })\r\n}\r\n\r\n/**\r\n * Creates success response with consistent format\r\n */\r\nfunction createSuccessResponse(data, statusCode = 200) {\r\n  return NextResponse.json({\r\n    success: true,\r\n    status: 'success',\r\n    timestamp: new Date().toISOString(),\r\n    ...data\r\n  }, { status: statusCode })\r\n}\r\n\r\n/**\r\n * Creates redirect URL for browser requests\r\n */\r\nfunction createRedirectUrl(baseUrl, encResponse, clientCode, statusInfo, error = null) {\r\n  const redirectUrl = new URL('/response', baseUrl)\r\n  redirectUrl.searchParams.set('encResponse', encResponse)\r\n  redirectUrl.searchParams.set('clientCode', clientCode)\r\n  redirectUrl.searchParams.set('success', statusInfo.status === 'success' ? 'true' : 'false')\r\n  \r\n  if (error) {\r\n    redirectUrl.searchParams.set('error', error)\r\n  }\r\n  \r\n  return redirectUrl.toString()\r\n}\r\n\r\n// ============================================\r\n// MAIN API HANDLER\r\n// ============================================\r\n\r\n/**\r\n * GET handler for payment callback\r\n * Processes payment callbacks from SabPaisa gateway\r\n */\r\nexport async function GET(request) {\r\n  try {\r\n    // Extract parameters from query string\r\n    const { searchParams } = new URL(request.url)\r\n    const clientCode = searchParams.get('clientCode')\r\n    const encResponse = searchParams.get('encResponse')\r\n\r\n    console.log('üì• Payment callback received:', { \r\n      clientCode, \r\n      encResponseLength: encResponse?.length || 0,\r\n      timestamp: new Date().toISOString()\r\n    })\r\n\r\n    // Validate required parameters\r\n    const validation = validateCallbackParams(clientCode, encResponse)\r\n    if (!validation.isValid) {\r\n      return createErrorResponse('Missing required parameters', 400, {\r\n        missing: {\r\n          clientCode: !clientCode,\r\n          encResponse: !encResponse\r\n        },\r\n        errors: validation.errors\r\n      })\r\n    }\r\n\r\n    // Get encryption keys from environment variables\r\n    const authKey = process.env.AUTH_KEY || process.env.NEXT_PUBLIC_AUTH_KEY || DEFAULT_AUTH_KEY\r\n    const authIV = process.env.AUTH_IV || process.env.NEXT_PUBLIC_AUTH_IV || DEFAULT_AUTH_IV\r\n\r\n    // Decrypt the payment response\r\n    console.log('üîì Decrypting payment response...')\r\n    let decryptedData = decryptSabPaisaResponse(encResponse, authKey, authIV)\r\n    \r\n    // Validate decrypted data\r\n    if (decryptedData && decryptedData.status === 'error') {\r\n      console.error('‚ùå Decryption error:', decryptedData.message)\r\n      return createErrorResponse('Payment data decryption failed: ' + decryptedData.message, 400, {\r\n        encResponseFormat: {\r\n          length: encResponse?.length || 0,\r\n          sample: encResponse?.substring(0, 50) + '...' || 'empty',\r\n          isHex: /^[0-9A-Fa-f]+$/.test(encResponse || ''),\r\n          isBase64: /^[A-Za-z0-9+/=]+$/.test(encResponse || '')\r\n        }\r\n      })\r\n    }\r\n\r\n    if (!decryptedData) {\r\n      return createErrorResponse('Empty decrypted response', 400)\r\n    }\r\n\r\n    if (typeof decryptedData !== 'object' || decryptedData === null) {\r\n      console.error('‚ùå Invalid decrypted data format:', typeof decryptedData)\r\n      return createErrorResponse('Decrypted response is not a valid object', 400, {\r\n        dataType: typeof decryptedData\r\n      })\r\n    }\r\n\r\n    console.log('‚úÖ Decryption successful. Available fields:', Object.keys(decryptedData))\r\n\r\n    // Map payment status from SabPaisa response\r\n    const statusInfo = mapPaymentStatus(decryptedData)\r\n    \r\n    // Extract transaction details\r\n    const transactionId = extractField(decryptedData, ['txnId', 'transactionId', 'clientTxnId'], '')\r\n    const clientTxnId = extractField(decryptedData, ['clientTxnId', 'clientTransactionId'], '')\r\n    \r\n    console.log('üìä Payment Status:', statusInfo.status)\r\n    console.log('üí∞ Transaction ID:', transactionId)\r\n    console.log('üÜî Client Transaction ID:', clientTxnId)\r\n\r\n    // Build payload for Site B update\r\n    const updatePayload = buildSiteBPayload(decryptedData, statusInfo)\r\n    \r\n    console.log('üì¶ Site B Payload:', {\r\n      txnId: updatePayload.txnId,\r\n      amount: updatePayload.amount,\r\n      status: updatePayload.status,\r\n      payerName: updatePayload.payerName,\r\n      payerEmail: updatePayload.payerEmail,\r\n      statusCode: updatePayload.statusCode\r\n    })\r\n\r\n    // Send transaction update to Site B\r\n    try {\r\n      console.log('üì§ Sending transaction to Site B...')\r\n      const siteBResponse = await sendTransactionToSiteB(updatePayload)\r\n      console.log('‚úÖ Site B response received:', siteBResponse)\r\n\r\n      // Handle browser vs API requests differently\r\n      if (isBrowserRequest(request)) {\r\n        const redirectUrl = createRedirectUrl(request.url, encResponse, clientCode, statusInfo)\r\n        console.log('üåê Redirecting browser to:', redirectUrl)\r\n        return NextResponse.redirect(redirectUrl, { status: 302 })\r\n      }\r\n\r\n      // Return JSON for API requests\r\n      return createSuccessResponse({\r\n        message: 'Payment callback processed successfully',\r\n        paymentStatus: statusInfo.status,\r\n        paymentMessage: statusInfo.message,\r\n        transactionId,\r\n        clientTxnId,\r\n        siteBResponse\r\n      })\r\n\r\n    } catch (siteBError) {\r\n      console.error('‚ùå Site B update failed:', siteBError.message)\r\n      \r\n      // For browser requests, still redirect (payment was processed)\r\n      if (isBrowserRequest(request)) {\r\n        const redirectUrl = createRedirectUrl(\r\n          request.url, \r\n          encResponse, \r\n          clientCode, \r\n          statusInfo, \r\n          'Failed to update Site B'\r\n        )\r\n        console.log('üåê Redirecting browser (Site B error):', redirectUrl)\r\n        return NextResponse.redirect(redirectUrl, { status: 302 })\r\n      }\r\n      \r\n      // For API requests, return error but with 200 (payment was processed)\r\n      return createSuccessResponse({\r\n        message: 'Payment processed but failed to update Site B',\r\n        paymentStatus: statusInfo.status,\r\n        paymentMessage: statusInfo.message,\r\n        transactionId,\r\n        clientTxnId,\r\n        siteBError: siteBError.message,\r\n        warning: 'Payment was processed but Site B update failed'\r\n      }, 200)\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Payment callback error:', error)\r\n    return createErrorResponse('Internal server error', 500, {\r\n      error: error.message,\r\n      errorType: error.constructor.name\r\n    })\r\n  }\r\n}\r\n\r\n/**\r\n * POST handler for payment callback\r\n * Some payment gateways may use POST instead of GET\r\n */\r\nexport async function POST(request) {\r\n  // Convert POST to GET handler for compatibility\r\n  return GET(request)\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}